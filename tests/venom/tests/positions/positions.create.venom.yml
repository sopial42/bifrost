name: Positions service
version: '2'

testcases:
  - name: Reset db
    steps:
      - type: dbfixtures
        database: postgres
        dsn: "{{ .pgsql_dsn }}"
        migrations: ../../data/schemas/
        folder: ../../data/fixtures/positions/create
        retry: 10
  - name: Create positions
    steps:
      - type: http
        method: POST
        url: "{{.url}}/positions"
        headers:
          Content-Type: application/json
        body: |
          {
            "positions": [
              {
                "buy_signal_id": "123e4567-e89b-12d3-a456-426614174000",
                "name": "simple",
                "fullname": "simple-1-1",
                "tp": 10,
                "sl": 9,
                "metadata": {
                  "entry_type": "market",
                  "leverage": 1,
                  "size": 0.1,
                  "notes": "Strong trend following golden cross"
                },
                "ratio": 0.5
              }
            ]
          }
        assertions:
          - result.statuscode ShouldEqual 201
          - result.bodyjson ShouldHaveLength 1
          - result.bodyjson.positions.positions0 ShouldHaveLength 9
          - result.bodyjson.positions.positions0.name ShouldEqual "simple"
          - result.bodyjson.positions.positions0.fullname ShouldEqual "simple-1-1"
          - result.bodyjson.positions.positions0.buy_signal_id ShouldEqual 123e4567-e89b-12d3-a456-426614174000
          - result.bodyjson.positions.positions0.id ShouldHaveLength 36
          - result.bodyjson.positions.positions0.buy_signal ShouldBeNil
          - result.bodyjson.positions.positions0.tp ShouldEqual 10
          - result.bodyjson.positions.positions0.sl ShouldEqual 9
          - result.bodyjson.positions.positions0.serial_id ShouldEqual 10001
          - result.bodyjson.positions.positions0.metadata ShouldHaveLength 4
          - result.bodyjson.positions.positions0.metadata.entry_type ShouldEqual "market"
          - result.bodyjson.positions.positions0.metadata.leverage ShouldEqual 1
          - result.bodyjson.positions.positions0.metadata.size ShouldEqual 0.1
          - result.bodyjson.positions.positions0.metadata.notes ShouldEqual "Strong trend following golden cross"
          - result.bodyjson.positions.positions0.ratio ShouldEqual 0.5
