name: Candles service
version: '2'

testcases:
  - name: Reset db 
    steps:
      - type: dbfixtures
        database: postgres
        dsn: "{{ .pgsql_dsn }}"
        migrations: ../../data/schemas/
        folder: ../../data/fixtures/candles/patch
        retry: 10
  - name: Patch candles with RSI
    steps:
      - type: http
        method: PATCH
        url: "{{.url}}/candles/rsi"
        headers:
          Content-Type: application/json
        body: |
          {
            "candles": [
              {
                "id": "83e98bf6-aa44-48df-b86a-5ad84b02295a",
                "pair": "IGNORED CHANGE",
                "rsi": {
                  "50": 50.3
                }
              }
            ]
          }
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson ShouldHaveLength 1
          - result.bodyjson.candles.candles0 ShouldHaveLength 9
          - result.bodyjson.candles.candles0.id ShouldHaveLength 36
          - result.bodyjson.candles.candles0.date ShouldEqual 2024-02-08T00:00:00Z
          - result.bodyjson.candles.candles0.pair ShouldEqual BTCUSDT
          - result.bodyjson.candles.candles0.interval ShouldEqual 4h
          - result.bodyjson.candles.candles0.open ShouldEqual 44349.6
          - result.bodyjson.candles.candles0.close ShouldEqual 44540.99
          - result.bodyjson.candles.candles0.high ShouldEqual 44780
          - result.bodyjson.candles.candles0.low ShouldEqual 44331.1
          - result.bodyjson.candles.candles0.rsi ShouldHaveLength 1
          - result.bodyjson.candles.candles0.rsi.50 ShouldEqual 50.3
      - name: Get all candles to check only one RSI changed
        type: http
        method: GET
        url: "{{.url}}/candles?pair=BTCUSDT&interval=4h"
        assertions:
          - result.statuscode ShouldEqual 200
          - result.bodyjson ShouldHaveLength 3
          - result.bodyjson.has_more ShouldEqual false
          - result.bodyjson.next_cursor ShouldEqual ""
          - result.bodyjson.candles.candles0 ShouldHaveLength 9
          - result.bodyjson.candles.candles0.rsi.50 ShouldEqual 50.3
          - result.bodyjson.candles.candles1 ShouldHaveLength 8
          - result.bodyjson.candles.candles1.rsi ShouldBeNil
          - result.bodyjson.candles.candles2 ShouldHaveLength 8
          - result.bodyjson.candles.candles1.rsi ShouldBeNil
